<!-- 2825e481-a59b-4550-894c-d8d92d6a7932 dc56db2a-fd6c-4321-9564-7a85af897921 -->
# FlexFilter Standalone Tool Integration

## Summary

Move `run_flexfilter_mex` from `reference/tools/` to `tools/flexfilter/`, wire it into the main Makefile, and add self-contained tests using the existing gold standard fixtures.

## Key Files

- **Source**: `reference/tools/run_flexfilter_mex.cpp` (806 lines) - the CLI wrapper
- **Build**: `reference/tools/Makefile.flexfilter` - current standalone build
- **Fixtures**: `tests/gold_standard/raw/` (composite MEX) and `tests/gold_standard/per_sample/` (expected outputs)

## Steps

### 1. Stage sources into `tools/flexfilter/`

- Copy `run_flexfilter_mex.cpp` to `tools/flexfilter/`
- Copy `README_run_flexfilter_mex.md` to `tools/flexfilter/README.md`
- **Move** `Makefile.flexfilter` to `tools/flexfilter/Makefile` (preserve known-good link flags)
- Update include paths in source to use `-I` flags from Makefile

### 2. Adjust Makefile paths and link line

Update moved `tools/flexfilter/Makefile`:

- Fix `LIBFLEX_DIR` to `../../source/libflex`
- Use `pkg-config --cflags glib-2.0` instead of hard-coded paths
- Ensure htslib link: `-L../../source/htslib -lhts` or static
- Link deps: `libflex.a`, `MexWriter.o`, htslib, glib, pthread, fopenmp

Add to `source/Makefile`:

```makefile
flexfilter: STAR$(SFX)
	$(MAKE) -C ../tools/flexfilter
```

### 3. Add smoke test with skip guard

Create `tools/flexfilter/test_smoke.sh`:

- **Skip-if-missing**: Exit 0 with warning if `tests/gold_standard/` absent
- Build tool via `make -C ../../source flexfilter`
- Run on `tests/gold_standard/raw/` with `--total-expected 12000`
- Assert per-sample output directories exist (BC004, BC006, BC007, BC008)
- Verify non-empty MEX files in each

### 4. Add contract validation

Create `tools/flexfilter/validate_output.py`:

- Verify per-sample directories exist and match expected tags
- Check `barcodes.tsv`: 24-char composite, TAG suffix matches sample
- Check `features.tsv`: tab-separated, non-empty
- Check `matrix.mtx`: valid Matrix Market header
- If gold `flexfilter_summary.tsv` present: compare total cell counts; else warn/skip

### 5. Update documentation

Add to `README_flex.md`:

- Note `make flexfilter` is **optional** (not built by default `make STAR`)
- Requires gold fixtures or user-provided composite MEX to test
- Link to `tools/flexfilter/README.md` for CLI details

### To-dos

- [ ] Copy run_flexfilter_mex.cpp and README to tools/flexfilter/, fix include paths
- [ ] Add flexfilter target to source/Makefile and create tools/flexfilter/Makefile
- [ ] Create test_smoke.sh using tests/gold_standard/ fixtures
- [ ] Create validate_output.py for output format validation
- [ ] Add flexfilter tool section to README_flex.md