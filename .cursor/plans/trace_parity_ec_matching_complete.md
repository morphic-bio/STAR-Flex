# Trace Parity with Matching ECs - Complete

**Date**: December 19, 2025  
**Status**: ✅ EC Matching Complete, Per-EC Comparison Enabled

## Solution: Use Same EC File

**Approach**: Used the EC file generated by Salmon during trace generation (211 ECs) and ran em_quant with that same file.

### Steps Taken

1. **Extracted Salmon's EC file**:
   ```bash
   gunzip -c /tmp/salmon_trace_out/aux_info/eq_classes.txt.gz > /tmp/salmon_eq_classes_211.txt
   ```
   - Confirmed: 211 ECs (matches Salmon trace)

2. **Generated em_quant trace with matching EC file**:
   ```bash
   export EM_QUANT_DEBUG_TXPS=ENST00000215754,ENST00000215770,ENST00000645799
   ./tools/em_quant/em_quant --vb --uniform-init --threads 1 \
       -e /tmp/salmon_eq_classes_211.txt \
       -l test/fixtures/salmon_eq/quant.sf \
       -o /tmp/em_output_211ec.tsv \
       --debug-trace /tmp/em_trace_211ec.txt
   ```

3. **Compared traces with matching EC IDs**:
   ```bash
   python3 tools/em_quant/compare_traces.py \
       /tmp/em_trace_211ec.txt /tmp/salmon_trace.txt \
       --transcript ENST00000215754
   ```

## Results

### Per-Iteration Comparison: ✅ Excellent Match

**Iteration -1 (Initialization)**:
- alpha: em=71.3571, salmon=71.3637, diff=0.009% ✅
- logNorm: em=8.51609, salmon=8.51623, diff=0.002% ✅
- expTheta: em=0.0141872, salmon=0.0141865, diff=0.005% ✅

**Iteration 0**:
- alpha: em=25.5094, salmon=25.5098, diff=0.002% ✅
- expTheta: em=0.00500702, salmon=0.00500710, diff=0.002% ✅
- expected_count: em=25.4994, salmon=25.4998, diff=0.002% ✅

**Subsequent iterations**: All <0.03% difference ✅

### EC-Level Comparison: ✅ Enabled

Now that EC IDs match, we can compare per-EC contributions to identify:
- First divergence point in EC processing
- Whether differences are due to:
  - Digamma/precision (expected small differences)
  - True algorithmic mismatch (would show systematic differences)
  - Weights parsing/order issues
  - Convergence criteria differences

## Files

- **Salmon EC file**: `/tmp/salmon_eq_classes_211.txt` (211 ECs)
- **em_quant trace (211 ECs)**: `/tmp/em_trace_211ec.txt`
- **Salmon trace**: `/tmp/salmon_trace.txt`
- **Comparison tool**: `tools/em_quant/compare_traces.py`

## Next Steps

1. **Analyze EC-level differences**:
   ```bash
   python3 tools/em_quant/compare_traces.py \
       /tmp/em_trace_211ec.txt /tmp/salmon_trace.txt \
       --transcript ENST00000215754 \
       --ec-details
   ```

2. **Identify first divergence**:
   - Check if differences are systematic or random
   - Determine if due to floating-point precision or algorithm differences

3. **Document findings**:
   - Root cause of any remaining differences
   - Whether differences are acceptable (precision) or need fixes (algorithm)

## Key Achievement

✅ **EC matching resolved**: Both tools now use identical EC sets (211 ECs), enabling:
- Per-EC contribution comparison
- Identification of first divergence point
- Distinction between precision vs algorithmic differences

The initialization fix + EC matching enables full trace comparison to isolate any residual differences.
